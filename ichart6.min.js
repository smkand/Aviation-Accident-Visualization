margin={top:40,right:5,bottom:190,left:50},margin2={top:370,right:5,bottom:30,left:50},width=650-margin.left-margin.right,height=550-margin.top-margin.bottom,height2=500-margin2.top-margin2.bottom,parseDate=d3.time.format("%Y-%m").parse,formatPercent=d3.format(".0%"),x=d3.time.scale().range([0,width]),x2=d3.time.scale().range([0,width]),y=d3.scale.linear().range([height,0]),y2=d3.scale.linear().range([height2,0]),outcomes=["total_fatal_injuries","total_minor_injuries","total_serious_injuries","total_uninjured"],leg_keys=["#d43f3a","#204d74","#d58512","#398439"],color=d3.scale.ordinal().domain(outcomes).range(leg_keys),xAxis=d3.svg.axis().scale(x).orient("bottom"),xAxis2=d3.svg.axis().scale(x2).orient("bottom"),yAxis=d3.svg.axis().scale(y).orient("left").tickFormat(formatPercent),area=d3.svg.area().interpolate("monotone").x(function(t){return x(t.date)}).y0(function(t){return y(t.y0)}).y1(function(t){return y(t.y0+t.y)}),area2=d3.svg.area().interpolate("monotone").x(function(t){return x2(t.date)}).y0(function(t){return y2(t.y0)}).y1(function(t){return y2(t.y0+t.y)}),stack=d3.layout.stack().values(function(t){return t.values}),svg=d3.select(".echart").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",width).attr("height",height),reclip=function(){return svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",width).attr("height",height)},d3.csv("data/year_month_outcomes.csv",function(t,a){var e,r,n,i,o,s;return a.forEach(function(t){return t.date=parseDate(t.year_month),t.total=parseInt(t.total_fatal_injuries)+parseInt(t.total_serious_injuries)+parseInt(t.total_minor_injuries)+parseInt(t.total_uninjured)}),s=stack(color.domain().map(function(t){return{name:t,values:a.map(function(a){return{date:a.date,y:a[t]/a.total}})}})),x.domain(d3.extent(a,function(t){return t.date})),x2.domain(x.domain()),svg.append("text").attr("x",width/2).attr("y",0-margin.top/4).attr("text-anchor","middle").style("font-size","14px").text("Proportion of Passenger Outcomes in Accidents Over Time"),o=svg.selectAll(".outcome").data(s).enter().append("g").attr("class","outcome"),o.append("path").attr("class","area").attr("d",function(t){return area(t.values)}).attr("data-legend",function(t){return t.name}).style("fill",function(t){return color(t.name)}),o.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),o.append("g").attr("class","y axis").call(yAxis),e=d3.bisector(function(t){return t.date}).left,svg.selectAll(".outcome").attr("opacity",1).on("mouseover",function(t,a){return svg.selectAll(".area").transition().duration(250).attr("opacity",function(t,e){return e!==a?.4:1})}).on("mousemove",function(){var t,a,r,n,i,o,l,c,d;return d=x.invert(d3.mouse(this)[0]),n=e(s[0].values,d,1),t=s[0].values[n-1],a=s[0].values[n],l=d-t.date>a.date-d?n:n-1,c=s[0].values[l],i=s[1].values[l],o=s[2].values[l],r=s[3].values[l]}).on("mouseout",function(t,a){return svg.selectAll(".area").transition().duration(250).attr("opacity","1")}),r=d3.svg.brush().x(x2).on("brush",function(){return r.empty()?x.domain(x2.domain()):x.domain(r.extent()),o.select(".area").attr("d",function(t){return area(t.values)}),o.select(".x.axis").call(xAxis)}),n=svg.selectAll(".context").data(s).enter().append("g").attr("class","context").attr("transform","translate(0,"+margin2.top+")"),n.append("path").attr("class","area").attr("d",function(t){return area2(t.values)}).style("fill",function(t){return color(t.name)}),n.append("g").attr("class","x axis").attr("transform","translate(0,"+height2+")").call(xAxis2),n.append("g").attr("class","x brush").call(r).selectAll("rect").attr("y",-6).attr("height",height2+7).attr("opacity","0.5"),i=svg.append("g").attr("class","legend").attr("transform","translate(40,250)").attr("data-style-padding",5).attr("opacity","0.6").style("font-size","14px").call(d3.legend)});