margin={top:40,right:5,bottom:190,left:50},margin2={top:370,right:5,bottom:30,left:50},width=650-margin.left-margin.right,height=550-margin.top-margin.bottom,height2=500-margin2.top-margin2.bottom,parseDate=d3.time.format("%Y-%m").parse,y=d3.scale.linear().range([height,0]),y2=d3.scale.linear().range([height2,0]),x=d3.time.scale().range([0,width]),x2=d3.time.scale().range([0,width]),color=d3.scale.ordinal().domain(["uninjured","minor","serious","fatal"]).range(["#8dd3c7","#ffffb3","#bebada","#fb8072"]),xAxis=d3.svg.axis().scale(x).orient("bottom"),xAxis2=d3.svg.axis().scale(x2).orient("bottom"),yAxis=d3.svg.axis().scale(y).orient("left"),line=d3.svg.line().interpolate("monotone").x(function(t){return x(t.date)}).y(function(t){return y(t.people)}),line2=d3.svg.line().interpolate("monotone").x(function(t){return x2(t.date)}).y(function(t){return y2(t.people)}),svg=d3.select(".echart").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),reclip=function(){return svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",width).attr("height",height)},d3.csv("data/year_month_outcomes.csv",function(t,e){var a,n,r,o,i;return reclip(),e.forEach(function(t){return t.year_month=parseDate(t.year_month)}),x.domain(d3.extent(e,function(t){return t.year_month})),x2.domain(x.domain()),y.domain([0,d3.max(e,function(t){return parseInt(t.total_uninjured)})]),y2.domain(y.domain()),svg.append("text").attr("x",width/2).attr("y",0-margin.top/4).attr("text-anchor","middle").style("font-size","14px").text("Passenger Outcomes in Accidents Over Time"),i={total_fatal_injuries:[],total_minor_injuries:[],total_serious_injuries:[],total_uninjured:[]},e.map(function(t){return i.total_fatal_injuries.push({outcome:"fatal",date:t.year_month,people:parseInt(t.total_fatal_injuries)}),i.total_minor_injuries.push({outcome:"minor",date:t.year_month,people:parseInt(t.total_minor_injuries)}),i.total_serious_injuries.push({outcome:"serious",date:t.year_month,people:parseInt(t.total_serious_injuries)}),i.total_uninjured.push({outcome:"total_uninjured",date:t.year_month,people:parseInt(t.total_uninjured)})}),r=[{outcome:"fatal",values:i.total_fatal_injuries},{outcome:"minor",values:i.total_minor_injuries},{outcome:"serious",values:i.total_serious_injuries},{outcome:"uninjured",values:i.total_uninjured}],console.log(r),o=svg.selectAll(".outcome").data(r).enter().append("g").attr("class","outcome"),o.append("path").attr("class","line").attr("d",function(t){return line(t.values)}).style("stroke",function(t){return color(t.outcome)}).attr("data-legend",function(t){return t.outcome}),o.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),o.append("g").attr("class","y axis").call(yAxis).append("text").attr("transform","rotate(-90)").attr("y",-45).attr("dy",".71em").style("text-anchor","end").text("Number of People"),a=d3.svg.brush().x(x2).on("brush",function(){return a.empty()?x.domain(x2.domain()):x.domain(a.extent()),o.select(".line").attr("d",function(t){return line(t.values)}),o.select(".x.axis").call(xAxis)}),n=svg.selectAll(".context").data(r).enter().append("g").attr("class","context").attr("transform","translate(0,"+margin2.top+")"),n.append("path").attr("class","line").attr("d",function(t){return line2(t.values)}).style("stroke",function(t){return color(t.outcome)}),n.append("g").attr("class","x axis").attr("transform","translate(0,"+height2+")").call(xAxis2),legend=svg.append("g").attr("class","legend").attr("transform","translate(40,250)").attr("data-style-padding",5).attr("opacity","0.6").style("font-size","14px").call(d3.legend),n.append("g").attr("class","x brush").call(a).selectAll("rect").attr("y",-6).attr("height",height2+7)});
